<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ECE Attendance - G. Nagarjuna</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --p-color: #28a745; --a-color: #dc3545; --n-color: #6c757d; }
        body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; padding-bottom: 80px; }
        .sticky-header { position: sticky; top: 0; background: #004085; color: white; z-index: 1000; padding: 10px; border-bottom: 2px solid #ffc107; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .mode-container { background: rgba(255,255,255,0.15); border-radius: 8px; padding: 10px; margin: 8px 0; border: 1px solid rgba(255,255,255,0.2); }
        .student-card { background: white; border-radius: 8px; margin-bottom: 6px; padding: 12px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; border-left: 6px solid #ccc; transition: 0.2s; }
        .student-card.is-p { border-left-color: var(--p-color); background: #e8f5e9; }
        .student-card.is-a { border-left-color: var(--a-color); background: #fce4ec; }
        .badge-status { padding: 4px 10px; border-radius: 6px; color: white; font-weight: bold; font-size: 0.8rem; min-width: 30px; text-align: center; }
        .badge-p { background: var(--p-color); }
        .badge-a { background: var(--a-color); }
        .badge-n { background: var(--n-color); }
        .stat-box { text-align: center; }
        .stat-val { display: block; font-size: 1.1rem; font-weight: 800; }
        .stat-lbl { font-size: 0.55rem; text-transform: uppercase; opacity: 0.8; }
        #subject-manual { background: white; color: #004085; border: none; font-size: 0.8rem; font-weight: bold; padding: 4px 8px; border-radius: 4px; width: 100%; }
        .action-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 10px; display: flex; gap: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1001; }
    </style>
</head>
<body>

<div class="sticky-header">
    <div class="container p-1">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <h6 class="m-0 fw-bold">G. NAGARJUNA</h6>
                <div style="font-size:0.65rem; color:#ffc107">ECE ATTENDANCE PORTAL</div>
            </div>
            <div class="text-end">
                <span id="perc-display" class="badge bg-warning text-dark fw-bold">0% ATTENDANCE</span>
            </div>
        </div>

        <div class="mode-container">
            <div class="d-flex justify-content-around">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="mode" id="modeP" value="P" checked onchange="updateMode()">
                    <label class="form-check-label fw-bold small" for="modeP">MARK PRESENTEES</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="mode" id="modeA" value="A" onchange="updateMode()">
                    <label class="form-check-label fw-bold small" for="modeA">MARK ABSENTEES</label>
                </div>
            </div>
        </div>

        <div class="row g-1 align-items-center mb-2">
            <div class="col-3">
                <select id="sec-sel" class="form-select form-select-sm fw-bold" onchange="initList()">
                    <option value="A">SEC A</option><option value="B">SEC B</option><option value="C">SEC C</option>
                </select>
            </div>
            <div class="col-4">
                <select id="per-sel" class="form-select form-select-sm" onchange="autoSubject()">
                    <option value="0">P1 (9:20)</option><option value="1">P2 (10:10)</option>
                    <option value="2">P3 (11:10)</option><option value="3">P4 (12:00)</option>
                    <option value="4">P5 (1:30)</option><option value="5">P6 (2:20)</option>
                    <option value="6">P7 (3:10)</option>
                </select>
            </div>
            <div class="col-5">
                <input type="text" id="subject-manual" placeholder="Enter Subject Name">
            </div>
        </div>

        <div class="row text-white">
            <div class="col-4 stat-box"><span id="s-total" class="stat-val">0</span><span class="stat-lbl">Total</span></div>
            <div class="col-4 stat-box" style="color:#4ade80"><span id="s-p" class="stat-val">0</span><span class="stat-lbl">Present</span></div>
            <div class="col-4 stat-box" style="color:#f87171"><span id="s-a" class="stat-val">0</span><span class="stat-lbl">Absent</span></div>
        </div>
    </div>
</div>

<div class="container mt-3" id="list"></div>

<div class="action-bar">
    <button class="btn btn-primary w-100 fw-bold" onclick="sendReport()">üì§ POST REPORT</button>
    <button class="btn btn-danger w-100 fw-bold" onclick="alertParents()">‚ö†Ô∏è ALERT PARENTS</button>
</div>

<script>
    const schedules = {
        'A': {'MON':['ADC','EMTL','LDICA','ECA','ECA Lab','ECA Lab','ADC'],'TUE':['PTSP','ADC','E','LDICA','EMTL','ECA','LDICA'],'WED':['ECA Lab','ECA Lab','EMTL','ECA','E','LDICA','ADC'],'THU':['E','E','E','LDICA','PTSP','U','ADC'],'FRI':['PTSP','EMTL','ADC','ECA','LDICA','PTSP','EMTL'],'SAT':['ADC','PTSP','EMTL','LDICA','E','NPTEL','LIB']},
        'B': {'MON':['ECA','EMTL','E','PTSP','LDICA','ADC','PTSP'],'TUE':['E','ADC','LDICA','PTSP','E','E','E'],'WED':['EMTL','ECA','ADC','E','PTSP','EMTL','LDICA'],'THU':['ADC','ECA','EMTL','LDICA','ADC','PTSP','EMTL'],'FRI':['ECA','ADC','EMTL','PTSP','E','LDICA','ADC'],'SAT':['EMTL','PTSP','LDICA','ADC','E','NPTEL','LIB']},
        'C': {'MON':['ADC','LDICA','ECA','E','E','E','ECA LAB'],'TUE':['PTSP','EMTL','ADC','LDICA','PTSP','EMTL','ADC'],'WED':['ECA','ADC','E','PTSP','EMTL','LDICA','ADC'],'THU':['EMTL','A','ECA','LDICA','E','EMTL','PTSP'],'FRI':['ADC','E','ECA','PTSP','EMTL','ADC','LDICA'],'SAT':['PTSP','EMTL','ADC','LDICA','A','NPTEL','LIB']}
    };

    // Database with Parent Numbers ("p"). Format: 91 followed by 10 digits.
    const studentData = {
        'A': [{"r":"24E11A0401","n":"A.SANDEEP KUMAR","p":"919999999999"},{"r":"24E11A0402","n":"ABBAS AKSHAYA","p":"919999999999"}], // ... Add more
        'B': [{"r":"24E11A0456","n":"AMBATI VARUN KUMAR","p":"919999999999"}],
        'C': [{"r":"24E11A04B1","n":"ADUPA HARINI","p":"919999999999"}]
    };

    let attendance = {};
    let markMode = 'P';

    function updateMode() {
        markMode = document.querySelector('input[name="mode"]:checked').value;
    }

    function initList() {
        const sec = document.getElementById('sec-sel').value;
        const listDiv = document.getElementById('list');
        listDiv.innerHTML = '';
        attendance = {};
        
        const students = studentData[sec];
        document.getElementById('s-total').innerText = students.length;

        students.forEach(s => {
            attendance[s.r] = '0'; 
            const card = document.createElement('div');
            card.className = 'student-card';
            card.id = `card-${s.r}`;
            card.onclick = () => toggleStudent(s.r);
            card.innerHTML = `
                <div>
                    <div class="fw-bold" style="font-size:0.85rem">${s.r}</div>
                    <div class="text-muted" style="font-size:0.7rem">${s.n}</div>
                </div>
                <div id="status-${s.r}" class="badge-status badge-n">0</div>
            `;
            listDiv.appendChild(card);
        });
        updateStats();
        autoSubject();
    }

    function toggleStudent(roll) {
        if (attendance[roll] === markMode) {
            attendance[roll] = '0';
        } else {
            attendance[roll] = markMode;
        }
        refreshUI(roll);
        updateStats();
    }

    function refreshUI(roll) {
        const card = document.getElementById(`card-${roll}`);
        const badge = document.getElementById(`status-${roll}`);
        const status = attendance[roll];
        card.classList.remove('is-p', 'is-a');
        if(status === '0') {
            badge.className = 'badge-status badge-n';
            badge.innerText = '0';
        } else {
            card.classList.add(status === 'P' ? 'is-p' : 'is-a');
            badge.className = `badge-status badge-${status.toLowerCase()}`;
            badge.innerText = status;
        }
    }

    function updateStats() {
        const sec = document.getElementById('sec-sel').value;
        const total = studentData[sec].length;
        const rolls = Object.keys(attendance);
        let pCount = 0;
        let aCount = 0;

        rolls.forEach(r => {
            if (markMode === 'P') {
                if (attendance[r] === 'P') pCount++; else aCount++;
            } else {
                if (attendance[r] === 'A') aCount++; else pCount++;
            }
        });

        const percentage = ((pCount / total) * 100).toFixed(1);
        document.getElementById('s-p').innerText = pCount;
        document.getElementById('s-a').innerText = aCount;
        document.getElementById('perc-display').innerText = `${percentage}% ATTENDANCE`;
    }

    function autoSubject() {
        const sec = document.getElementById('sec-sel').value;
        const per = document.getElementById('per-sel').value;
        const day = ['SUN','MON','TUE','WED','THU','FRI','SAT'][new Date().getDay()];
        const sched = schedules[sec][day] || schedules[sec]['MON'];
        document.getElementById('subject-manual').value = sched[per] || "FREE";
    }

    function getReportData() {
        const sec = document.getElementById('sec-sel').value;
        const perIdx = document.getElementById('per-sel').value;
        const perText = document.getElementById('per-sel').options[perIdx].text;
        const sub = document.getElementById('subject-manual').value.toUpperCase();
        const total = studentData[sec].length;
        
        let presentRolls = [];
        let absentList = []; // Array of objects {r, n, p}

        studentData[sec].forEach(s => {
            const status = attendance[s.r];
            let isPresent = (markMode === 'P') ? (status === 'P') : (status !== 'A');
            
            if (isPresent) {
                presentRolls.push(s.r);
            } else {
                absentList.push(s);
            }
        });

        const perc = ((presentRolls.length / total) * 100).toFixed(1);
        return { sec, perText, sub, presentRolls, absentList, perc, total };
    }

    function sendReport() {
        const d = getReportData();
        const dateStr = new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        
        let msg = `*üìä ATTENDANCE: ECE - ${d.sec}*\n`;
        msg += `*üìÖ Date:* ${dateStr}\n*‚è∞ Period:* ${d.perText}\n*üìò Subject:* ${d.sub}\n\n`;
        msg += `*‚úÖ Present:* ${d.presentRolls.length}\n*‚ùå Absent:* ${d.absentList.length}\n`;
        msg += `*üìà Percentage:* ${d.perc}%\n\n`;
        msg += `*‚îÄ‚îÄ‚îÄ ABSENTEES üî¥ ‚îÄ‚îÄ‚îÄ*\n`;

        if (d.absentList.length > 0) {
            d.absentList.forEach(s => { msg += `‚Ä¢ ${s.r}\n`; });
        } else {
            msg += "*NIL (All Present)*";
        }

        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
    }

    function alertParents() {
        const d = getReportData();
        if (d.absentList.length === 0) return alert("No absentees to notify!");

        if (confirm(`This will open WhatsApp for ${d.absentList.length} parents. Continue?`)) {
            d.absentList.forEach((s, index) => {
                setTimeout(() => {
                    const msg = `Dear Parent, your child ${s.n} (${s.r}) is ABSENT for the ${d.perText} (${d.sub}) class today (${new Date().toLocaleDateString()}). - ECE Dept.`;
                    window.open(`https://wa.me/${s.p}?text=${encodeURIComponent(msg)}`, '_blank');
                }, index * 1500); // 1.5s delay to prevent browser blocking
            });
        }
    }

    initList();
</script>
</body>
</html>
