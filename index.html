<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ECE Attendance - G. Nagarjuna</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --p-color: #28a745; --a-color: #dc3545; --n-color: #6c757d; }
        body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; padding-bottom: 100px; }
        .sticky-header { position: sticky; top: 0; background: #004085; color: white; z-index: 1000; padding: 10px; border-bottom: 2px solid #ffc107; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .mode-container { background: rgba(255,255,255,0.15); border-radius: 8px; padding: 10px; margin: 8px 0; border: 1px solid rgba(255,255,255,0.2); }
        .student-card { background: white; border-radius: 8px; margin-bottom: 6px; padding: 12px; display: flex; align-items: center; justify-content: space-between; border-left: 6px solid #ccc; transition: 0.2s; }
        .student-card.is-p { border-left-color: var(--p-color); background: #e8f5e9; }
        .student-card.is-a { border-left-color: var(--a-color); background: #fce4ec; }
        .stat-val { display: block; font-size: 1.1rem; font-weight: 800; color: #ffc107; }
        .stat-lbl { font-size: 0.6rem; text-transform: uppercase; opacity: 0.8; }
        .action-footer { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 12px; display: flex; gap: 10px; box-shadow: 0 -4px 10px rgba(0,0,0,0.1); z-index: 1001; }
        .call-btn { background: #007bff; color: white; border: none; border-radius: 5px; padding: 5px 10px; text-decoration: none; font-size: 0.8rem; font-weight: bold; }
        #subject-manual { background: white; color: #004085; border: none; font-size: 0.8rem; font-weight: bold; padding: 4px 8px; border-radius: 4px; width: 100%; }
    </style>
</head>
<body>

<div class="sticky-header">
    <div class="container p-1">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <h6 class="m-0 fw-bold">G. NAGARJUNA</h6>
                <div style="font-size:0.65rem; color:#ffc107">ECE ATTENDANCE PORTAL</div>
            </div>
            <div class="text-center">
                <span id="perc-display" class="stat-val">0%</span>
                <span class="stat-lbl">ATTENDANCE</span>
            </div>
        </div>

        <div class="mode-container">
            <div class="d-flex justify-content-around">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="mode" id="modeP" value="P" checked onchange="updateMode()">
                    <label class="form-check-label fw-bold small" for="modeP">MARK PRESENTEES</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="mode" id="modeA" value="A" onchange="updateMode()">
                    <label class="form-check-label fw-bold small" for="modeA">MARK ABSENTEES</label>
                </div>
            </div>
        </div>

        <div class="row g-1 align-items-center mb-2">
            <div class="col-3">
                <select id="sec-sel" class="form-select form-select-sm fw-bold" onchange="initList()">
                    <option value="A">SEC A</option><option value="B">SEC B</option><option value="C">SEC C</option>
                </select>
            </div>
            <div class="col-4">
                <select id="per-sel" class="form-select form-select-sm" onchange="autoSubject()">
                    <option value="0">P1</option><option value="1">P2</option>
                    <option value="2">P3</option><option value="3">P4</option>
                    <option value="4">P5</option><option value="5">P6</option><option value="6">P7</option>
                </select>
            </div>
            <div class="col-5">
                <input type="text" id="subject-manual" placeholder="Subject Name">
            </div>
        </div>
    </div>
</div>

<div class="container mt-3" id="list"></div>

<div class="action-footer">
    <button class="btn btn-primary w-100 fw-bold" onclick="sendReport()">üì§ POST REPORT</button>
    <button class="btn btn-danger w-100 fw-bold" onclick="alertParents()">‚ö†Ô∏è ALERT FATHERS</button>
</div>

<script>
    const studentData = {
        'A': [{"r":"24E11A0401","n":"A.SANDEEP KUMAR","p":"919059144275"},{"r":"24E11A0402","n":"ABBAS AKSHAYA","p":"919059144275"}],
        'B': [{"r":"24E11A0456","n":"AMBATI VARUN KUMAR","p":"917777777777"}],
        'C': [{"r":"24E11A04B1","n":"ADUPA HARINI","p":"916666666666"}]
    };

    let attendance = {};
    let markMode = 'P';

    function updateMode() {
        markMode = document.querySelector('input[name="mode"]:checked').value;
    }

    function initList() {
        const sec = document.getElementById('sec-sel').value;
        const listDiv = document.getElementById('list');
        listDiv.innerHTML = '';
        attendance = {};
        
        studentData[sec].forEach(s => {
            attendance[s.r] = '0'; // Neutral
            const card = document.createElement('div');
            card.className = 'student-card';
            card.id = `card-${s.r}`;
            card.innerHTML = `
                <div onclick="toggleStudent('${s.r}')" style="flex-grow:1">
                    <div class="fw-bold" style="font-size:0.85rem">${s.r}</div>
                    <div class="text-muted" style="font-size:0.7rem">${s.n}</div>
                </div>
                <a href="tel:${s.p}" class="call-btn">üìû CALL</a>
            `;
            listDiv.appendChild(card);
        });
        updateStats();
    }

    function toggleStudent(roll) {
        if (attendance[roll] === markMode) {
            attendance[roll] = '0';
        } else {
            attendance[roll] = markMode;
        }
        refreshUI(roll);
        updateStats();
    }

    function refreshUI(roll) {
        const card = document.getElementById(`card-${roll}`);
        card.classList.remove('is-p', 'is-a');
        if(attendance[roll] === 'P') card.classList.add('is-p');
        if(attendance[roll] === 'A') card.classList.add('is-a');
    }

    function updateStats() {
        const sec = document.getElementById('sec-sel').value;
        const total = studentData[sec].length;
        let pCount = 0;

        studentData[sec].forEach(s => {
            const status = attendance[s.r];
            let isPresent = (markMode === 'P') ? (status === 'P') : (status !== 'A');
            if (isPresent) pCount++;
        });

        const percentage = total > 0 ? ((pCount / total) * 100).toFixed(1) : 0;
        document.getElementById('perc-display').innerText = `${percentage}%`;
    }

    function sendReport() {
        const sec = document.getElementById('sec-sel').value;
        const sub = document.getElementById('subject-manual').value.toUpperCase();
        const total = studentData[sec].length;
        
        let absentees = [];
        let pCount = 0;

        studentData[sec].forEach(s => {
            const status = attendance[s.r];
            let isPresent = (markMode === 'P') ? (status === 'P') : (status !== 'A');
            if (isPresent) pCount++; else absentees.push(s.r);
        });

        const perc = ((pCount / total) * 100).toFixed(1);
        const dateStr = new Date().toLocaleDateString();

        let msg = `*üìä ATTENDANCE: ECE - ${sec}*\n*üìÖ Date:* ${dateStr}\n*üìò Subject:* ${sub}\n*üìà Attendance:* ${perc}%\n\n`;
        msg += `*‚úÖ Present:* ${pCount}\n*‚ùå Absent:* ${absentees.length}\n\n*‚îÄ‚îÄ‚îÄ ABSENTEES üî¥ ‚îÄ‚îÄ‚îÄ*\n`;
        msg += absentees.length > 0 ? absentees.join(", ") : "NIL";

        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
    }

    function alertParents() {
        const sec = document.getElementById('sec-sel').value;
        const absentees = studentData[sec].filter(s => {
            const status = attendance[s.r];
            return (markMode === 'P') ? (status !== 'P') : (status === 'A');
        });

        if(absentees.length === 0) return alert("No absentees marked.");

        if(confirm(`Send WhatsApp alert to ${absentees.length} parents?`)) {
            absentees.forEach((s, i) => {
                setTimeout(() => {
                    const msg = `Dear Parent, your child ${s.n} (${s.r}) is ABSENT for the ECE class today. Please ensure they attend regularly.`;
                    window.open(`https://wa.me/${s.p}?text=${encodeURIComponent(msg)}`, '_blank');
                }, i * 2000);
            });
        }
    }

    initList();
</script>
</body>
</html>
